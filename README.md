# Polaris Sidecar

## 介绍

polaris-sidecar 作为 polaris 的本地边车代理，提供两个可选功能：

- 本地 DNS：使用 DNS 解析的方式访问北极星上的服务
- 服务网格：通过劫持流量的方式实现服务发现和治理，开发侵入性低

本文档介绍如何在虚拟机或者容器环境中安装和使用 polaris-sidecar。

## 安装说明

### 前提条件

- 在安装和使用 polaris-sidecar 之前，需要先安装北极星服务端，安装方式请参考[北极星服务端安装文档](https://polarismesh.cn/zh/doc/快速入门/安装服务端/安装单机版.html#单机版安装)。
- 需要从[Releases](https://github.com/polarismesh/polaris-sidecar/releases)下载最新版本的安装包。

### 虚拟机环境下安装

虚拟机环境下只能支持```本地 DNS```的功能，以下为安装步骤：

1. 虚拟机安装过程需要使用root用户或者具有超级管理员权限的用户来执行，并且确保53（udp/tcp）端口没有被占用。
2. 上传安装包到虚拟机环境中，并进行解压，进入解压后的目录。
```
unzip polaris-sidecar-release_$version.$os.$arch.zip
```
3. 修改polaris.yaml，写入北极星服务端的地址，端口号使用8091（GRPC端口）。
```
global:
  serverConnector:
    addresses:
      - 127.0.0.1:8091
```
4. 进入解压后的目录，执行tool/start.sh进行启动，然后执行tool/p.sh查看进程是否启动成功。
```
# bash tool/start.sh
# bash ./tool/p.sh
root     15318     1  0 Jan22 ?        00:07:50 ./polaris-sidecar start
```
5. 修改/etc/resolv.conf，在文件中添加```nameserver 127.0.0.1```，并且添加到所有的nameserver记录前面，如下：
```
; generated by /usr/sbin/dhclient-script
nameserver 127.0.0.1
nameserver x.x.x.x
```
6. 验证安装，使用格式为```<service>.<namespace>.polaris```的域名进行访问，可以获得一个经过负载均衡后的IP地址。
```
# dig testsvc.default.polaris

; <<>> DiG 9.9.4-RedHat-9.9.4-29.el7_2.2 <<>> testsvc.default.polaris
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 27445
;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
;; WARNING: recursion requested but not available

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;testsvc.default.polaris.       IN      A

;; ANSWER SECTION:
testsvc.default.polaris. 0      IN      AAAA    ::ffff:19.22.31.51

;; Query time: 0 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Sun Jan 23 23:10:26 CST 2022
;; MSG SIZE  rcvd: 103
```

备注：如果需要使用域名的方式进行服务发现，则必须保证命名空间和服务名在北极星上都是以全小写字母进行注册，否则会寻址失败。

### 容器环境下安装

容器环境下，polaris-sidecar容器与业务容器是在同一个pod中运行的，可以通过手动注入或者自动注入的方式进行polaris-sidecar的安装。

#### 手动注入

下面流程会介绍如何通过手动注入的方式，将polaris-sidecar注入到业务容器中。

polaris-sidecar镜像是归档到dockerhub中，需要确保部署的环境网络可以访问dockerhub公有镜像仓库。

1. 从[Releases](https://github.com/polarismesh/polaris-sidecar/releases)下载最新版本的源码包，解压并进入解压后的源码目录。
2. 添加configmap：polaris-sidecar-config。
```
kubectl apply -f deploy/configmap/polaris-sidecar-config.yaml
```
3. 修改deploy/configmap/polaris-client-config.yaml，写入北极星服务端的地址，端口号使用8091（GRPC端口）。
```
apiVersion: v1
kind: ConfigMap
metadata:
  name: polaris-client-config
data:
  polaris.yaml: |-
    global:
      serverConnector:
        addresses:
          - 127.0.0.1:8091
```
4. 添加configmap：polaris-client-config。
```
kubectl apply -f deploy/configmap/polaris-client-config.yaml
```
5. 在应用的上部署spec中添加polaris-sidecar容器的部署脚本，相关添加位置如下：
```
#在containers下，添加polaris-sidecar的镜像部署配置
containers:
  - image: polarismesh/polaris-sidecar:v1.0.0
    imagePullPolicy: Always
    name: polaris-sidecar
    terminationMessagePath: /dev/termination-log
    terminationMessagePolicy: File
    volumeMounts:
      - mountPath: /root/polaris-sidecar.yaml
        name: polaris-sidecar-config
        subPath: polaris-sidecar.yaml
      - mountPath: /root/polaris.yaml
        name: polaris-client-config
        subPath: polaris.yaml  
#在volumes下，添加polaris-sidecar-config和polaris-client-config的挂载配置
volumes:
  - configMap:
      defaultMode: 420
      name: polaris-sidecar-config
    name: polaris-sidecar-config
  - configMap:
      defaultMode: 420
      name: polaris-client-config
    name: polaris-client-config
```
添加后的部署配置最终效果可以参考deploy/spec/sidecar-dns-example.yaml。